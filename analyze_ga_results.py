#!/usr/bin/env python3
"""
GA 결과 분석 및 시각화 스크립트
"""

import json
import argparse
from pathlib import Path
from typing import Dict, List
from collections import defaultdict


def analyze_solution(solution_file: str, detailed_file: str = None):
    """
    GA 해를 분석하고 통계를 출력
    
    Args:
        solution_file: 요약 결과 JSON
        detailed_file: 상세 결과 JSON (옵션)
    """
    
    print("=" * 60)
    print("GA 의존성 해결 - 결과 분석")
    print("=" * 60)
    
    # 요약 결과 로드
    with open(solution_file) as f:
        solution = json.load(f)
    
    print(f"\n[기본 정보]")
    print(f"Python 버전: {solution['python_version']}")
    print(f"적합도: {solution['fitness']:.1f}")
    
    packages = solution.get('packages', {})
    print(f"설치된 패키지 수: {len(packages)}")
    
    # 상세 결과 로드 (있으면)
    if detailed_file and Path(detailed_file).exists():
        with open(detailed_file) as f:
            detailed = json.load(f)
        all_packages = detailed.get('all_packages', {})
        uninstalled = {pkg: ver for pkg, ver in all_packages.items() if ver is None}
        print(f"미설치 패키지 수: {len(uninstalled)}")
    
    # 패키지 목록 출력
    print(f"\n[설치된 패키지 목록]")
    for pkg, ver in sorted(packages.items()):
        print(f"  {pkg:30} {ver}")
    
    # 통계
    print(f"\n[통계]")
    versions = list(packages.values())
    print(f"패키지당 평균 버전 숫자: {sum(len(v.split('.')) for v in versions) / len(versions):.2f}")
    
    # 메이저 버전 분석
    major_versions = defaultdict(int)
    for ver in versions:
        major = ver.split('.')[0]
        major_versions[major] += 1
    
    print(f"\nMajor 버전 분포:")
    for major in sorted(major_versions.keys()):
        count = major_versions[major]
        pct = 100.0 * count / len(versions)
        bar = "█" * (count // 2)
        print(f"  {major:3}: {bar} ({count:2}, {pct:5.1f}%)")
    
    print("\n" + "=" * 60)


def compare_solutions(file1: str, file2: str):
    """
    두 개의 GA 해를 비교
    
    Args:
        file1: 첫 번째 해 JSON
        file2: 두 번째 해 JSON
    """
    
    print("=" * 60)
    print("GA 해 비교")
    print("=" * 60)
    
    with open(file1) as f:
        sol1 = json.load(f)
    with open(file2) as f:
        sol2 = json.load(f)
    
    print(f"\n[해 1: {file1}]")
    print(f"Python: {sol1['python_version']}, 패키지: {len(sol1['packages'])}, 적합도: {sol1['fitness']}")
    
    print(f"\n[해 2: {file2}]")
    print(f"Python: {sol2['python_version']}, 패키지: {len(sol2['packages'])}, 적합도: {sol2['fitness']}")
    
    # 공통 패키지
    pkgs1 = set(sol1['packages'].keys())
    pkgs2 = set(sol2['packages'].keys())
    
    common = pkgs1 & pkgs2
    only1 = pkgs1 - pkgs2
    only2 = pkgs2 - pkgs1
    
    print(f"\n[비교]")
    print(f"공통 패키지: {len(common)}")
    print(f"해1에만: {len(only1)}")
    print(f"해2에만: {len(only2)}")
    
    # 버전 차이
    diff_count = 0
    for pkg in common:
        if sol1['packages'][pkg] != sol2['packages'][pkg]:
            diff_count += 1
            print(f"  {pkg}: {sol1['packages'][pkg]} → {sol2['packages'][pkg]}")
    
    if diff_count == 0:
        print("  (모든 공통 패키지의 버전이 동일)")
    else:
        print(f"  (총 {diff_count}개 패키지의 버전 차이)")
    
    print("\n" + "=" * 60)


def export_requirements(solution_file: str, output_file: str = "requirements_from_ga.txt"):
    """
    GA 해를 requirements.txt 형식으로 내보내기
    
    Args:
        solution_file: 해 JSON 파일
        output_file: 출력 파일 경로
    """
    
    with open(solution_file) as f:
        solution = json.load(f)
    
    packages = solution.get('packages', {})
    
    print(f"[requirements.txt로 내보내기]")
    print(f"출력 파일: {output_file}")
    
    with open(output_file, 'w') as f:
        # Python 버전 주석
        f.write(f"# Generated by GA Dependency Solver\n")
        f.write(f"# Python: {solution['python_version']}\n")
        f.write(f"# Fitness: {solution['fitness']}\n\n")
        
        # 패키지 목록
        for pkg in sorted(packages.keys()):
            ver = packages[pkg]
            f.write(f"{pkg}=={ver}\n")
    
    print(f"[완료] {len(packages)}개 패키지를 {output_file}에 저장했습니다.")
    print(f"\n생성된 파일:")
    with open(output_file) as f:
        for i, line in enumerate(f):
            if i < 10:  # 처음 10줄만 표시
                print(f"  {line.rstrip()}")
    if len(packages) > 10:
        print(f"  ... ({len(packages) - 10}개 더)")


def main():
    """메인 함수"""
    parser = argparse.ArgumentParser(
        description="GA 의존성 해결 결과 분석 및 시각화"
    )
    
    subparsers = parser.add_subparsers(dest='command', help='명령어')
    
    # analyze 서브커맨드
    analyze_parser = subparsers.add_parser('analyze', help='해 분석')
    analyze_parser.add_argument('solution_file', help='해 JSON 파일')
    analyze_parser.add_argument('--detailed', help='상세 JSON 파일 (옵션)')
    
    # compare 서브커맨드
    compare_parser = subparsers.add_parser('compare', help='두 해 비교')
    compare_parser.add_argument('file1', help='첫 번째 해 JSON')
    compare_parser.add_argument('file2', help='두 번째 해 JSON')
    
    # export 서브커맨드
    export_parser = subparsers.add_parser('export', help='requirements.txt로 내보내기')
    export_parser.add_argument('solution_file', help='해 JSON 파일')
    export_parser.add_argument('--output', '-o', default='requirements_from_ga.txt', 
                               help='출력 파일 (기본값: requirements_from_ga.txt)')
    
    args = parser.parse_args()
    
    if args.command == 'analyze':
        analyze_solution(args.solution_file, args.detailed)
    elif args.command == 'compare':
        compare_solutions(args.file1, args.file2)
    elif args.command == 'export':
        export_requirements(args.solution_file, args.output)
    else:
        parser.print_help()


if __name__ == '__main__':
    main()
